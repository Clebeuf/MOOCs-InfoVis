<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">

	<!-- JQuery script -->
	<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>

	<!-- Style sheet for D3 -->
	<link rel="stylesheet" type="text/css" href="css/style.css">

	<!-- BOOTSTRAP SCRIPTS-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

	<link rel="stylesheet" type="text/css" href="https://syntagmatic.github.io/parallel-coordinates/d3.parcoords.css">
	<title>MOOCs Success InfoVis</title>

</head>

<body onload="loadCoordinates()">

	<!-- SCRIPTS -->
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="https://syntagmatic.github.io/parallel-coordinates/d3.parcoords.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="js/datamaps.world.min.js"></script>

	<div class="container">

		<div class="row">
			<div class="col-md-12">
				<h1>Visualizing MOOCs Success</h1>
			</div>
		</div>
		<div class="row">
			<div class="col-md-2">
				<div class="form-group">
					<h4>Filters:</h4>
					<form id="frm1" onchange="refreshCoordinates()">
						Type of Data:
						<select id="explored">
						  <option value="1">Explored</option>
						  <option value="0">Not Explored</option>
						</select>
						<div class="checkbox">
						  	Years:
						      <br><label><input type="checkbox" id="2012" checked> 2012</label>
						      <br><label><input type="checkbox" id="2013"> 2013</label>
						</div>
					</form>
					<form id="courseForm" onchange="refreshCoordinates()">
						<div class="checkbox">
						  	Harvard Courses:
								<br><label><input type="checkbox" id="PH207x" checked> HealthStat</label>
								<br><label><input type="checkbox" id="PH278x" checked> HealthEnv</label>
								<br><label><input type="checkbox" id="CB22x" checked> HeroesX*</label>
								<br><label><input type="checkbox" id="CS50x" checked> Intro to CS*</label>
								<br><label><input type="checkbox" id="ER22x" checked> JusticeX*</label>
							<br>MIT Courses:
								<br><label><input type="checkbox" id="14.73x" checked> Poverty</label>
								<br><label><input type="checkbox" id="2.01x" checked> Structures</label>
								<br><label><input type="checkbox" id="3.091x" checked> SS Chem</label>
								<br><label><input type="checkbox" id="6.002x" checked> Circuits</label>
								<br><label><input type="checkbox" id="6.00x" checked> Intro to CS</label>
								<br><label><input type="checkbox" id="7.00x" checked> Biology</label>
								<br><label><input type="checkbox" id="8.02x" checked> Electricity</label>
								<br><label><input type="checkbox" id="8.MReV" checked> MechRev</label>
						</div>
						<a onclick="javascript:checkAll(true);" href="javascript:void();">check all</a>
						<a onclick="javascript:checkAll(false);" href="javascript:void();">uncheck all</a>
					</form>
					<br><br>

					<form id="frm2">
						<select id="dimensionMapped">
							<option value="certified">Certified</option>
							<option value="grade">Grade</option>
							<option value="gender">Gender</option>
						</select>
					</form>
					<br />
					<button onclick="getBrushedData()">See on Map</button>
				</div>
			</div>
			<div class="col-md-10">

				<div id="example" class="parcoords" style="width:100%;height:400px"></div>

				<script>


				function checkAll(checktoggle){
				  var checkboxes = document.getElementsByTagName('input');

				  for (var i=0; i<checkboxes.length; i++)  {
				    if (checkboxes[i].type == 'checkbox')   {
				    	if (["PH207x","PH278x","CB22x","CS50x","ER22x","14.73x","2.01x","3.091x","6.002x","6.00x","7.00x","8.02x","8.MReV"].indexOf(checkboxes[i].id) > -1){
				    		 checkboxes[i].checked = checktoggle;
				    	}
				    }
				  }
				  refreshCoordinates();
				}

					// CREATE THE PARALLEL COORDINATES
					var pc = d3.parcoords({
						dimensionTitles: {
							nplay_video: "video plays",
							final_cc_cname_DI: "country",
							LoE_DI: "education level",
							nevents: "# of events",
							nforum_posts: "# of forums posts",
							nchapters: "# of chapters",
							ndays_act: "# days active"
						}
					})('#example')

					// load the json data from a file
					var json = (function() {
				        var json = null;
				        $.ajax({
				            'async': false,
				            'global': false,
				            'url': "/data/output.json",
				            'dataType': "json",
				            'success': function (data) {
				                json = data;
				            }
				        });
				        return json;
				    })();

					function filterDataset(){
							var e = document.getElementById("explored");
							var strUser = e.options[e.selectedIndex].value;
							var exploredValue = parseInt(strUser);

							var dataFillered = json.filter(function (n) {
					    		if(exploredValue === 1){
					    			if(document.getElementById("2012").checked == true && document.getElementById("2013").checked == true){
					    				return (n.explored===1 && (n.year==2012 || n.year == 2013));
					    			}else if(document.getElementById("2012").checked == true){
					    				return (n.explored===1 && n.year==2012);
					    			}else if(document.getElementById("2013").checked){
					    				return (n.explored===1 && n.year==2013)
					    			};
					    		} else {
					    			if(document.getElementById("2012").checked == true){
					    				return (n.explored===0 && n.year==2012);
					    			};
					    			if(document.getElementById("2013").checked){
					    				return (n.explored===0 && n.year==2013)
					    			};
					    		}

							});

						return dataFillered
					}

					function filterByCourse(data){
						var dataFillered = json.filter(function (m) {
							if (document.getElementById("CB22x").checked && m.course_id=="CB22x"){
								return m.course_id=="CB22x";
							}else if (document.getElementById("CS50x").checked && m.course_id=="CS50x"){
								return m.course_id=="CS50x";
							}else if (document.getElementById("ER22x").checked && m.course_id=="ER22x"){
								return m.course_id=="ER22x";
							}else if (document.getElementById("PH207x").checked && m.course_id=="PH207x"){
								return m.course_id=="PH207x";
							}else if (document.getElementById("PH278x").checked && m.course_id=="PH278x"){
								return m.course_id=="PH278x";
							}else if (document.getElementById("14.73x").checked && m.course_id=="14.73x"){
								return m.course_id=="14.73x";
							}else if (document.getElementById("2.01x").checked && m.course_id=="2.01x"){
								return m.course_id=="2.01x";
							}else if (document.getElementById("3.091x").checked && m.course_id=="3.091x"){
								return m.course_id=="3.091x";
							}else if (document.getElementById("6.002x").checked && m.course_id=="6.002x"){
								return m.course_id=="6.002x";
							}else if (document.getElementById("6.00x").checked && m.course_id=="6.00x"){
								return m.course_id=="6.00x";
							}else if (document.getElementById("7.00x").checked && m.course_id=="7.00x"){
								return m.course_id=="7.00x";
							}else if (document.getElementById("8.02x").checked && m.course_id=="8.02x"){
								return m.course_id=="8.02x";
							}else if (document.getElementById("8.MReV").checked && m.course_id=="8.MReV"){
								return m.course_id=="8.MReV";
							}
						});

						return dataFillered
					}


					// load the coordinates from the file and set the options
					function loadCoordinates(){
						// create coloured tuples
						var colorgen = d3.scale.ordinal().range(["brown","steelblue"]);
						var color = function(d) { return colorgen(d.certified); };

						// generate the parallel-coordinates
						d3.json("data/explored.json", function(data) {
							pc.data(data)
							.ticks(4)
							.mode("queue")
							.color(color)
							.composite("darker")
							.alpha(0.15)
							.render()
							.dimensions(['LoE_DI','ndays_act', 'nchapters', 'nplay_video', 'nevents', 'nforum_posts', 'grade', 'certified'])
							.createAxes()
							.brushMode("1D-axes")
							.interactive()
							.reorderable();
						});
					}


					// refresh the coordinates for the new filters selected
					function refreshCoordinates(){

						// Filter the preloaded json
						dataF = filterDataset();

						dataC = filterByCourse(dataF);

						// refresh the coordinates
						pc.data(dataC)
						.render()
						.updateAxes();

					}

					var mapJson = {};

					function getBrushedData() {
						mapJson = {};
						mapJson = new Object;
						var data;
						if (pc.brushed()) {
							data = pc.brushed();
						} else {
							data = json;
						}
						for (i = 0; i < data.length; i++) {
							addToJsonMapData(data[i]);
						}
						changeJsonMap();
					}

					function addToJsonMapData(student) {
						var countryName = countryCodes[student.final_cc_cname_DI];

						if (!countryName) {
							if (student.final_cc_cname_DI != 'unknown') {
								console.log(student.final_cc_cname_DI);
							}
							return;
						}
						if (countryName in mapJson) {
							jsonObj = mapJson[countryName];
							jsonObj.totalStudents = jsonObj.totalStudents+1;
							if (student.certified) {
								jsonObj.certified = jsonObj.certified+1;
							} else {
								jsonObj.uncertified = jsonObj.uncertified+1;
							}
							if (student.gender == 'm') {
								jsonObj.males = jsonObj.males+1;
							} else if (student.gender == 'f') {
								jsonObj.females = jsonObj.females+1;
							}
							jsonObj.gradeTotal = jsonObj.gradeTotal+student.grade;
							mapJson[countryName] = jsonObj;
						} else {
							var newObj = {};
							newObj.totalStudents = 1;
							if (student.certified) {
								newObj.certified = 1;
								newObj.uncertified = 0;
							} else {
								newObj.certified = 0;
								newObj.uncertified = 1;
							}
							newObj.gradeTotal = student.grade;
							if (student.gender == 'm') {
								newObj.males = 1;
								newObj.females = 0;
							} else if (student.gender == 'f') {
								newObj.females = 1;
								newObj.males = 0;
							}
							mapJson[countryName] = newObj;
						}
					}

					var mapData = {};
					var dimensionToMap;
					function changeJsonMap() {
						for (var key in mapData) {
							if (!(key in mapJson)) {
								var newObj = {};
								newObj.certifiedPercent = 0;
								newObj.fillKey = 'defaultFill';
								mapData[key] = newObj;
							}
						}
						for (var key in mapJson) {
							var data = mapJson[key];

							var newObj = {};
							newObj.certified = data.certified;
							newObj.totalPeople = data.certified + data.uncertified;
							var percentage = newObj.certified / newObj.totalPeople;
							newObj.certifiedPercent = percentage;
							newObj.gradeAverage = data.gradeTotal / newObj.totalPeople;
							newObj.percentMale = data.males / newObj.totalPeople;
							newObj.percentFemale = data.females / newObj.totalPeople;

							var gradeAverage = newObj.gradeAverage;
							var dimension = document.getElementById("dimensionMapped");
							dimensionToMap = dimension.options[dimension.selectedIndex].value;

							var percentMale = newObj.percentMale;

							var fill;
							if (dimensionToMap === 'certified') {
								if (percentage < 0.20) {
									// fill = 'certified_very_low';
									fill = 'certvlow';
								} else if (percentage >= 0.20 && percentage < 0.40) {
									fill = 'certlow';
								} else if (percentage >= 0.40 && percentage < 0.60) {
									fill = 'certmedium';
								} else if (percentage >= 0.60 && percentage < 0.80) {
									fill = 'certhigh';
								} else {
									fill = 'certvhigh';
								}
							} else if (dimensionToMap === 'grade') {
								if (gradeAverage < 20) {
									fill = 'gradevlow';
								} else if (gradeAverage >= 20 && gradeAverage < 40) {
									fill = 'gradelow';
								} else if (gradeAverage >= 40 && gradeAverage < 60) {
									fill = 'grademedium';
								} else if (gradeAverage >= 60 && gradeAverage < 80) {
									fill = 'gradehigh';
								} else {
									fill = 'gradevhigh';
								}
							} else if (dimensionToMap === 'gender') {
								if (percentMale < .30) {
									fill = 'mostlyFemale';
								} else if (percentMale >= .30 && percentMale < .45) {
									fill = 'somewhatFemale';
								} else if (percentMale >= .45 && percentMale < .55) {
									fill = 'fiftyfifty';
								} else if (percentMale >= .55 && percentMale < .70) {
									fill = 'somewhatMale';
								} else {
									fill = 'mostlyMale';
								}
							}
							newObj.fillKey = fill;
							mapData[key] = newObj;
						}
						updateChoropleth(mapData);
					}

					var countryCodes = {};
					//Americas
					countryCodes['United States'] = 'USA';
					countryCodes['Canada'] = 'CAN';
					countryCodes['Mexico'] = 'MEX';
					countryCodes['Colombia'] = 'COL';
					countryCodes['Venezuela'] = 'VEN';
					countryCodes['Ecuador'] = 'ECU';
					countryCodes['Peru'] = 'PER';
					countryCodes['Brazil'] = 'BRA';
					countryCodes['Bolivia'] = 'BOL';
					countryCodes['Argentina'] = 'ARG';
					countryCodes['Chile'] = 'CHL';
					//Europe
					countryCodes['United Kingdom'] = 'GBR';
					countryCodes['Ireland'] = 'IRL';
					countryCodes['France'] = 'FRA';
					countryCodes['Spain'] = 'ESP';
					countryCodes['Portugal'] = 'PRT';
					countryCodes['Italy'] = 'ITA';
					countryCodes['Poland'] = 'POL';
					countryCodes['Greece'] = 'GRC';
					countryCodes['Germany'] = 'DEU';
					countryCodes['Norway'] = 'NOR';
					countryCodes['Sweden'] = 'SWE';
					countryCodes['Finland'] = 'FIN';
					countryCodes['Ukraine'] = 'UKR';
					countryCodes['Russian Federation'] = 'RUS';
					//Africa
					countryCodes['Egypt'] = 'EGY';
					countryCodes['Morocco'] = 'MAR';
					countryCodes['Nigeria'] = 'NGA';
					//Middle East
					countryCodes['Turkey'] = 'TUR';
					countryCodes['Iraq'] = 'IRQ';
					countryCodes['Iran'] = 'IRN';
					countryCodes['Saudi Arabia'] = 'SAU';
					countryCodes['Afghanistan'] = 'AFG';
					//Asia
					countryCodes['Pakistan'] = 'PAK';
					countryCodes['India'] = 'IND';
					countryCodes['Bangladesh'] = 'BGD';
					countryCodes['China'] = 'CHN';
					countryCodes['Thailand'] = 'THA';
					countryCodes['Cambodia'] = 'KHM';
					countryCodes['Vietnam'] = 'VNM';
					//korea?
					countryCodes['Japan'] = 'JPN';
					countryCodes['Malaysia'] = 'MYS';
					countryCodes['Philippines'] = 'PHL';
					countryCodes['Indonesia'] = 'IDN';
					countryCodes['Australia'] = 'AUS';
					countryCodes['New Zealand'] = 'NZL';

				</script>

				<!-- function to call popovers -->
				<script type="text/javascript">
					$(document).ready(function(){
					    $('[data-toggle="popover"]').popover();
					});
				</script>

			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<h3>THE TEMPORAL CONTROL GOES HERE</h3>
				<div id="slider"></div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12">
				<div id="basic" style="position: relative; width: 100%; height: 500px;"></div>

			     <script>
			       //basic map config with custom fills, mercator projection
					var basic = new Datamap({
						element: document.getElementById("basic"),
						fills: {
							defaultFill: "#ABDDA4",
							certvlow: "#87CEFA",
							certlow: "#6495ED",
							certmedium: "#4169E1",
							certhigh: "#0000FF",
							certvhigh: "#0000CD",
							gradevlow: "#FFFF00",
							gradelow: "#FFCC00",
							grademedium: "#FF9900",
							gradehigh: "#FF6600",
							gradevhigh: "#FF3300",
							mostlyMale: "#0B0B61",
							somewhatMale: "#3104B4",
							fiftyfifty: "#4000FF",
							somewhatFemale: "#8000FF",
							mostlyFemale: "#BF00FF"
						},
						data: {

						},
						geographyConfig: {
							popupTemplate: function(geo, data) {
								if (data == null) {
									return ['<div class="hoverinfo"><strong>',
									 	geo.properties.name,
										'</strong></div>'].join('');
								}
								else {
									//if looking at certified
									if (dimensionToMap === 'certified') {
										var percentage = data.certifiedPercent*100;
										percentage = percentage.toPrecision(3);
										return ['<div class="hoverinfo"><strong>',
					                        'Students Certified in ' + geo.properties.name,
					                        ': ' + percentage + '%', '<br />',
											data.certified + ' out of ' + data.totalPeople + ' certified',
					                        '</strong></div>'].join('');
									} else if (dimensionToMap === 'grade') {
										return ['<div class="hoverinfo"><strong>',
					                        'Average Grade of Students <br /> in ' + geo.properties.name,
					                        ': ' + data.gradeAverage.toPrecision(3) + '%', '<br />',
					                        '</strong></div>'].join('');
									} else if (dimensionToMap === 'gender') {
										var malePercent = data.percentMale*100;
										if (data.percentMale < 1 && data.percentMale > 0) malePercent = malePercent.toPrecision(2);
										var femalePercent = data.percentFemale*100;
										if (data.percentFemale < 1 && data.percentFemale > 0) femalePercent = femalePercent.toPrecision(2);
										return ['<div class="hoverinfo"><strong>',
					                        'Students in ' + geo.properties.name,
					                        '<br /> have a m:f ratio of ' + malePercent + ':' + femalePercent, '<br />',
											' out of ' + data.totalPeople + ' students', '<br />',
					                        '</strong></div>'].join('');
									}
								}
							}
						}
					});

					function updateChoropleth(json) {
						basic.updateChoropleth(json);
						// basic.legend();
					}

					getBrushedData();
			     </script>
			</div>
		 </div>
	 </div>
</body>
</html>
